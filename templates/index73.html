<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì˜¨ìŠµë„ ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§</title>
    <!-- ì™¸ë¶€ CSS ë§í¬ -->
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.8.1/socket.io.min.js"></script> <!-- Socket.IO ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ -->
    <!-- Bootstrap 5.3 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Bootstrap JS, jQuery, Popper.js -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.2/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <!-- Bootstrap JS & jQuery -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@2.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@1.0.0/dist/chartjs-adapter-moment.bundle.min.js"></script>

    <!-- Luxon for date handling in Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/luxon@2.0.2/build/global/luxon.min.js"></script>


</head>
<body>
    <div class="container my-5">
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h1 class="h3 mb-0">ì˜¨ìŠµë„ ì‹¤ì‹œê°„ ë°ì´í„°</h1>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="p-3 bg-light rounded">
                            <h2 class="h5 text-muted">ì˜¨ë„</h2>
                            <p class="display-6" id="temperature">--</p>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="p-3 bg-light rounded">
                            <h2 class="h5 text-muted">ìŠµë„</h2>
                            <p class="display-6" id="humidity">--</p>
                        </div>
                    </div>
                </div>
                <div class="mt-4">
                    <p class="lead">ê¸°ë¡ìƒíƒœ: <span id="sensor-state" class="badge bg-secondary">OFF</span></p>
                    <button id="toggle-btn" class="btn btn-lg btn-primary w-100">ì…ë ¥ ON/OFF</button>
                </div>
            </div>
        </div>

    <script>
        let socket = io.connect("http://" + document.domain + ":" + location.port);
        const sensorStateElement = document.getElementById("sensor-state");
        const toggleButton = document.getElementById("toggle-btn");

        // WebSocket ì—°ê²° í™•ì¸
        socket.on("connect", function () {
            console.log("âœ… WebSocket ì—°ê²° ì„±ê³µ!");

        });

       // ğŸ”¥ ì„¼ì„œ ë°ì´í„° ìˆ˜ì‹ 
       socket.on("update_data", function (data) {
            console.log("ğŸ“¥ ë°ì´í„° ìˆ˜ì‹ :", data);
            if (data.state === "on") {
                document.getElementById("temperature").innerText = data.temperature;
                document.getElementById("humidity").innerText = data.humidity;
            } else {
                document.getElementById("temperature").innerText = "--";
                document.getElementById("humidity").innerText = "--";
            }
        });        

        // ì„¼ì„œ ìƒíƒœ ë³€ê²½ ê°ì§€
        socket.on("sensor_state", function (data) {
            console.log("ğŸ”„ ì„¼ì„œ ìƒíƒœ ì—…ë°ì´íŠ¸:", data.state);
            sensorStateElement.innerText = data.state.toUpperCase();
            toggleButton.innerText = data.state === "on" ? "OFF" : "ON";
            // ì„¼ì„œê°€ "off" ìƒíƒœë©´ í™”ë©´ì—ì„œ ê°’ ìˆ¨ê¸°ê¸°
            if (data.state === "off" || data.state == null) {
                document.getElementById("temperature").innerText = "--";
                document.getElementById("humidity").innerText = "--";
            }
        });

        // ğŸ”¥ ë²„íŠ¼ í´ë¦­ ì‹œ ì„¼ì„œ ON/OFF ì „í™˜ ìš”ì²­
        toggleButton.addEventListener("click", function () {
            socket.emit("toggle_sensor");
        });        

          // WebSocket ì—°ê²° ì¢…ë£Œ ì‹œ ì•Œë¦¼
        socket.on("disconnect", function () {
            console.log("âŒ WebSocket ì—°ê²° ëŠê¹€!..ëŒ€ê¸°ì¤‘");
            setTimeout(() => {
                socket.connect(); // WebSocket ì¬ì—°ê²°
            }, 1000);
         });
         
    </script>
<form id="downloadForm">
    <label for="start_date">ì‹œì‘ì¼:</label>
    <input type="date" id="start_date" name="start_date" value="{{ today }}" required>

    <label for="end_date">ì¢…ë£Œì¼:</label>
    <input type="date" id="end_date" name="end_date" value="{{ today }}" required>

    <button type="button" onclick="downloadExcel()">ë‹¤ìš´ë¡œë“œ</button>
</form>

<script>
    function downloadExcel() {
        const startDate = document.getElementById("start_date").value;
        const endDate = document.getElementById("end_date").value;

        if (!startDate || !endDate) {
            alert("ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”.");
            return;
        }

        const url = `/download_excel?start_date=${startDate}&end_date=${endDate}`;
        window.location.href = url;
    }
</script>
<div class="container my-5">
    <div class="card shadow">
        <div class="card-header bg-primary text-white">
            <h3 class="h4 mb-0">ì˜¨ë„ ê·¸ë˜í”„</h3>
        </div>
    </div>
</div>
<canvas id="temperatureChart"></canvas>
<script>
    const ctx = document.getElementById('temperatureChart').getContext('2d');

    const temperatureChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],  // ì‹œê°„ ë°ì´í„° (ë‚˜ì¤‘ì— AJAXë¡œ ë°›ì•„ì˜¬ ì˜ˆì •)
            datasets: [{
                label: 'Temperature (Â°C)',
                data: [],  // ì˜¨ë„ ë°ì´í„° (ë‚˜ì¤‘ì— AJAXë¡œ ë°›ì•„ì˜¬ ì˜ˆì •)
                borderColor: 'rgba(75, 192, 192, 1)',
                fill: false
            }]
        },
        options: {
            responsive: true,
            scales: {
                x: {
                    type: 'time',  // ì‹œê°„ ì¶• ì‚¬ìš©
                    time: {
                        unit: 'minute',  // ì‹œê°„ ë‹¨ìœ„ ì„¤ì • (ì˜ˆ: 'minute', 'hour', 'day')
                        tooltipFormat: 'll HH:mm',
                        displayFormats: {
                            minute: 'HH:mm',  // ë¶„ ë‹¨ìœ„ë¡œ í‘œì‹œ
                        }
                    },
                    title: {
                        display: true,
                        text: 'Time'
                    }
                },
                y: {
                    min: 0,
                    max: 100,
                    title: {
                        display: true,
                        text: 'Temperature (Â°C)'
                    }
                }
            }
        }
    });

    // AJAXë¡œ ë°ì´í„°ë¥¼ ê°€ì ¸ì™€ì„œ ì°¨íŠ¸ ì—…ë°ì´íŠ¸
    function updateChartData() {
        $.get('/get_data', function(data) {
            const labels = [];
            const temperatureData = [];
            
            data.forEach(function(row) {
                labels.push(new Date(row.timestamp));  // luxon ì‚¬ìš©í•˜ì—¬ ë‚ ì§œ ê°ì²´ë¡œ ë³€í™˜
                temperatureData.push(row.temperature);  // ì˜¨ë„ ê°’
            });

            // ì°¨íŠ¸ ë°ì´í„° ê°±ì‹ 
            temperatureChart.data.labels = labels;
            temperatureChart.data.datasets[0].data = temperatureData;

            // ì°¨íŠ¸ ì—…ë°ì´íŠ¸
            temperatureChart.update();
        }).fail(function() {
            console.error("Error fetching data.");
        });
    }

    // 1ì´ˆë§ˆë‹¤ ë°ì´í„° ê°±ì‹ 
    setInterval(updateChartData, 4000);
</script>

</body>
</html>